## Game Recipe Book

Небольшое, но продуманное веб‑приложение на **FastAPI + Vue 3**, которое генерирует детальные «рецепты по игре» на основе текстового запроса (название игры, сеттинг, персонажи и т.п.) и позволяет сохранять их в личный кабинет.

---

## Возможности

- **Генерация игровых рецептов**
  - Ввод запроса в свободной форме: «горячий гуляш как в Ведьмак 3, на 4 порции», «пикник из Stardew Valley», «праздничный пир из Skyrim с ограничением по бюджету» и т.п.
  - Отправка запроса на backend (`/api/recipe`) и далее в **n8n**‑воркфлоу для генерации готового рецепта.
  - Отображение структурированного результата в удобном формате (заголовки, списки, шаги).

- **Современный фронтенд**
  - Одностраничный интерфейс на **Vue 3 (Composition API)**, монтируемый в Jinja2‑шаблон `index.html`.
  - Две основные вкладки:
    - **«Генерация рецептов»** — форма ввода запроса и просмотр текущего результата.
    - **«Личный кабинет»** — список сохранённых рецептов с выбором и редактированием.
  - Примеры запросов в один клик, контекстные подсказки по выбранной игре, статус‑индикатор «Онлайн‑советник».

- **Личный кабинет и CRUD по рецептам**
  - Регистрация и вход пользователя с безопасной аутентификацией.
  - Сохранение текущего рецепта в базу (`POST /api/recipes`).
  - Загрузка списка рецептов (`GET /api/recipes`).
  - Загрузка конкретного рецепта (`GET /api/recipes/{id}`).
  - Редактирование сохранённого рецепта (`PUT /api/recipes/{id}`).
  - Удаление рецепта (`DELETE /api/recipes/{id}`).
  - В интерфейсе: список рецептов, предпросмотр, выбор, редактирование и сохранение изменений.

- **Безопасность**
  - **Серверные сессии** — хранение сессий в БД с безопасными токенами.
  - **CSRF защита** — автоматическая проверка CSRF токенов для всех изменяющих запросов.
  - **Валидация входных данных** — проверка username и password на стороне сервера.
  - **Защита от timing attacks** — постоянное время выполнения при проверке паролей.
  - **Secure cookies** — поддержка HTTPS через переменную окружения `COOKIE_SECURE`.
  - **Хеширование паролей** — использование bcrypt для безопасного хранения паролей.

- **UI/UX**
  - Тёмная, аккуратная **glass‑/card‑стилистика** (см. `app/static/css/style.css`).
  - Адаптивная вёрстка (десктоп и мобильные устройства).
  - Модальные окна для входа и регистрации.
  - Плавные состояния загрузки, подсказки, валидация, удобочитаемый вывод рецептов.

- **Интеграция с n8n**
  - Backend пересылает текстовый запрос в n8n‑webhook.
  - n8n отвечает готовым текстом рецепта, который очищается от HTML‑тегов и выводится пользователю.

---

## Технологии

- **Backend**
  - FastAPI — основное веб‑API.
  - SQLAlchemy — ORM для работы с БД (SQLite).
  - Pydantic — валидация данных.
  - Uvicorn — ASGI сервер.
  - bcrypt — хеширование паролей.
  - **Серверные сессии** — хранение сессий в БД с автоматической очисткой истёкших.
  - **CSRF защита** — middleware для проверки CSRF токенов.

- **Frontend**
  - Vue 3 (Composition API) — логика приложения (`app/static/js/app.js`).
  - Jinja2 — серверный рендеринг базового шаблона (`app/templates/index.html`).
  - Чистый CSS без фреймворков (`app/static/css/style.css`).

- **База данных**
  - SQLite — локальная БД для хранения пользователей, рецептов и сессий.
  - Автоматические миграции при изменении схемы БД.

- **Интеграции**
  - **n8n** — генерация рецептов через webhook.

---

## Требования

- Python **3.12+**
- Установленные зависимости из `pyproject.toml`
- Запущенный/доступный **n8n** с настроенным webhook

---

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd game-recipe-book
```

### 2. Виртуальное окружение

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
```

### 3. Установка зависимостей

Через `pip`:

```bash
pip install -e .
```

или через `uv`:

```bash
uv sync
```

### 4. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
N8N_WEBHOOK_URL=https://ваш-n8n-сервер/webhook/ваш-id

# Опционально: для production установите COOKIE_SECURE=true
# COOKIE_SECURE=false  # для development (HTTP)
# COOKIE_SECURE=true   # для production (HTTPS)
```

Убедитесь, что соответствующий воркфлоу в n8n слушает этот webhook и возвращает JSON вида:

```json
{
  "recipe": "Текст сгенерированного рецепта..."
}
```

### 5. Запуск приложения

```bash
uvicorn app.main:app --reload
```

По умолчанию приложение будет доступно по адресу:

- `http://127.0.0.1:8000/`

При первом запуске автоматически создастся база данных `app/db/recipes.db` со всеми необходимыми таблицами.

---

## Краткое описание API

> Подробности см. в коде `app/routers/` (роуты), `app/services/` (бизнес-логика) и `app/auth.py` (аутентификация).

### Генерация рецепта

- `POST /api/recipe`
  - Тело: `{ "chat_input": "<строка запроса>" }`
  - Ответ: `{ "recipe": "<текст рецепта>" }`
  - Публичный эндпоинт, не требует аутентификации

### Аутентификация

- `POST /api/auth/register` — регистрация нового пользователя
  - Тело: `{ "username": "...", "password": "..." }`
  - Ответ: `{ "message": "...", "username": "...", "csrf_token": "..." }`
  - Автоматически создаёт сессию и возвращает CSRF токен

- `POST /api/auth/login` — вход пользователя
  - Тело: `{ "username": "...", "password": "..." }`
  - Ответ: `{ "message": "...", "username": "...", "csrf_token": "..." }`
  - Создаёт новую сессию и возвращает CSRF токен

- `POST /api/auth/logout` — выход пользователя
  - Требует аутентификации
  - Удаляет сессию и CSRF токен

- `GET /api/auth/me` — проверка текущей сессии
  - Ответ: `{ "user": { "id": ..., "username": "..." }, "csrf_token": "..." }`
  - Возвращает информацию о текущем пользователе и CSRF токен

- `GET /api/auth/csrf-token` — получение CSRF токена
  - Требует аутентификации
  - Ответ: `{ "csrf_token": "..." }`
  - Генерирует новый токен, если отсутствует

### Рецепты (личный кабинет)

Все эндпоинты требуют аутентификации и CSRF токен в заголовке `X-CSRF-Token`.

- `GET /api/recipes` — список рецептов текущего пользователя
  - Ответ: `{ "recipes": [...] }`

- `POST /api/recipes` — создание нового рецепта
  - Тело: `{ "title": "...", "content": "...", "original_query": "..." }`
  - Ответ: `{ "id": ..., "title": "...", "content": "...", "created_at": "..." }`

- `GET /api/recipes/{id}` — получение рецепта по ID
  - Ответ: `{ "id": ..., "title": "...", "content": "...", ... }`

- `PUT /api/recipes/{id}` — обновление рецепта
  - Тело: `{ "title": "...", "content": "..." }`
  - Ответ: `{ "id": ..., "title": "...", "content": "...", "updated_at": "..." }`

- `DELETE /api/recipes/{id}` — удаление рецепта
  - Ответ: `{ "message": "Рецепт удалён" }`

---

## Структура проекта

```text
game-recipe-book/
├── app/
│   ├── __init__.py
│   ├── main.py              # Точка входа FastAPI приложения (регистрация роутеров и middleware)
│   ├── config.py            # Конфигурация (переменные окружения, настройки безопасности)
│   ├── schemas.py           # Pydantic модели для валидации данных
│   ├── middleware.py        # Middleware функции (CSRF защита, очистка сессий)
│   ├── auth.py              # Функции аутентификации, сессий и CSRF защиты
│   ├── db/
│   │   ├── __init__.py
│   │   └── models.py        # Модели БД (User, Recipe, Session) и инициализация
│   ├── routers/             # Роутеры приложения
│   │   ├── __init__.py
│   │   ├── home.py          # Роуты главной страницы (GET /, POST /)
│   │   ├── auth.py          # Роуты аутентификации (/api/auth/*)
│   │   └── recipes.py       # Роуты для работы с рецептами (/api/recipes/*, /api/recipe)
│   ├── services/            # Бизнес-логика
│   │   ├── __init__.py
│   │   └── recipe_service.py # Сервис генерации рецептов (интеграция с n8n)
│   ├── templates/
│   │   └── index.html       # Jinja2-шаблон, в который монтируется Vue-приложение
│   └── static/
│       ├── css/
│       │   └── style.css    # Стиль тёмного, «glass»-интерфейса
│       └── js/
│           └── app.js       # Vue 3 (Composition API), логика генерации и личного кабинета
├── pyproject.toml           # Зависимости и настройки проекта
├── .env                     # Переменные окружения (не в git)
└── README.md                # Описание проекта (этот файл)
```

---

## Безопасность

### Реализованные меры защиты

1. **Серверные сессии**
   - Сессии хранятся в БД с безопасными токенами (32 байта, `secrets.token_urlsafe`)
   - Автоматическая очистка истёкших сессий через middleware
   - Сессии сохраняются между перезагрузками сервера

2. **CSRF защита**
   - CSRF токены хранятся в БД вместе с сессиями
   - Автоматическая проверка для всех изменяющих запросов (POST, PUT, DELETE)
   - Токен передаётся в заголовке `X-CSRF-Token`
   - Исключения для публичных эндпоинтов

3. **Валидация данных**
   - Username: 3-50 символов, только буквы, цифры и подчёркивание
   - Password: минимум 8 символов, максимум 128 символов
   - Валидация через Pydantic на стороне сервера

4. **Защита паролей**
   - Хеширование через bcrypt с автоматической генерацией соли
   - Защита от timing attacks при проверке паролей
   - Пароли никогда не хранятся в открытом виде

5. **Cookies**
   - `httponly=True` — защита от XSS
   - `samesite="lax"` — защита от CSRF
   - `secure=COOKIE_SECURE` — поддержка HTTPS (настраивается через переменную окружения)

### Рекомендации для production

1. Установите `COOKIE_SECURE=true` в `.env`
2. Используйте HTTPS (обязательно с `secure=True`)
3. Рассмотрите добавление rate limiting для защиты от брутфорса
4. Регулярно обновляйте зависимости

---

## Режим разработки

Для локальной разработки с авто‑перезапуском сервера:

```bash
uvicorn app.main:app --reload
```

Фронтенд — обычный статический Vue‑код; сборка не требуется, достаточно изменять файлы в `app/static/js/app.js` и `app/static/css/style.css`, перезагрузив страницу в браузере.

### Миграции БД

При изменении моделей БД миграции выполняются автоматически при запуске приложения. Если нужно пересоздать БД с нуля, удалите файл `app/db/recipes.db` и перезапустите приложение.

---

## Лицензия

MIT © 2025 Dudolin Deins. См. файл [`LICENSE`](LICENSE).
