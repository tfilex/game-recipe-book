<!-- app/templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Игровая Кулинарная Книга</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
    <div class="app-shell" id="app">
        <div class="glass-card">
            <div class="card-inner">
                <div class="header">
                    <div class="title-block">
                        <div class="logo-pill">
                            <div class="logo-pill-inner">
                                <span>GRB</span>
                            </div>
                        </div>
                        <div class="title-text">
                            <h1>Игровая кулинарная книга</h1>
                            <p>Получайте детальные рецепты, вдохновлённые любимыми играми.</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div v-if="user" class="user-info">
                            <span class="user-name">[[ user.username ]]</span>
                            <button class="auth-button" @click="handleLogout">Выход</button>
                        </div>
                        <div v-else>
                            <button class="auth-button" @click="showLoginModal = true">Вход</button>
                            <button class="auth-button" @click="showRegisterModal = true" style="margin-left: 8px;">Регистрация</button>
                        </div>
                        <div class="status-chip">
                            <span class="status-dot"></span>
                            <span>Онлайн‑советник</span>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <button
                        class="tab-button"
                        :class="{ 'tab-button--active': activeTab === 'generate' }"
                        @click="activeTab = 'generate'"
                    >
                        Генерация рецептов
                    </button>
                    <button
                        class="tab-button"
                        :class="{ 'tab-button--active': activeTab === 'cabinet' }"
                        @click="activeTab = 'cabinet'"
                    >
                        Личный кабинет
                    </button>
                </div>

                <div class="layout" v-if="activeTab === 'generate'">
                    <div class="panel">
                        <div class="panel-inner">
                            <div class="panel-header">
                                <div>
                                    <div class="panel-title">Запрос</div>
                                    <div class="panel-subtitle">Опишите блюдо и игру — остальное мы сделаем сами.</div>
                                </div>
                                <div class="badge">
                                    <span class="badge-dot"></span>
                                    <span>Режим рецептов</span>
                                </div>
                            </div>

                            <form @submit.prevent="handleSubmit">
                                <div>
                                    <label for="chat_input_vue">Что вы хотите приготовить?</label>
                                    <div class="hint">
                                        Например: «суп, как в The Witcher 3» или «десерт из Stardew Valley».
                                    </div>
                                </div>

                                <div class="input-wrapper">
                                    <textarea
                                        id="chat_input_vue"
                                        v-model="input"
                                        placeholder="Опишите блюдо, укажите игру, важные детали и ограничения по ингредиентам."
                                        :disabled="loading"
                                        required
                                    ></textarea>
                                </div>

                                <div class="actions-row">
                                    <div class="examples">
                                        <button
                                            type="button"
                                            class="example-pill"
                                            @click="applyExample('горячий гуляш как в Ведьмак 3, на 4 порции')"
                                        >
                                            Ведьмак 3 — гуляш
                                        </button>
                                        <button
                                            type="button"
                                            class="example-pill"
                                            @click="applyExample('пикник из Stardew Valley: лёгкий набор закусок, 2 порции')"
                                        >
                                            Stardew Valley — пикник
                                        </button>
                                        <button
                                            type="button"
                                            class="example-pill"
                                            @click="applyExample('праздничный пир из Skyrim, ограничение по бюджету')"
                                        >
                                            Skyrim — пир
                                        </button>
                                    </div>

                                    <button
                                        type="submit"
                                        class="primary-button"
                                        :disabled="loading || !input.trim()"
                                    >
                                        <span class="icon">▶</span>
                                        <span v-if="!loading">Создать рецепт</span>
                                        <span v-else>Готовим рецепт…</span>
                                        <span class="loader-dot" v-if="loading"></span>
                                    </button>
                                </div>
                            </form>

                        </div>
                    </div>

                    <div class="result-panel">
                        <div class="result-inner">
                            <div class="result-header">
                                <div class="result-title">Результат</div>
                                <div class="result-meta">
                                    <span class="pill-soft">
                                        <strong>Формат:</strong> подробный рецепт
                                    </span>
                                </div>
                            </div>

                            <div v-if="loading" class="empty-state">
                                <div class="empty-state-title">Ожидание<span class="loading-dots">...</span></div>
                            </div>
                            <div v-else-if="!currentRecipe" class="empty-state">
                                <div class="empty-state-title">Здесь появится ваш рецепт.</div>
                                <div>Попробуйте один из вариантов:</div>
                                <ul class="empty-state-list">
                                    <li>восстановить легендарное блюдо из любимой RPG;</li>
                                    <li>адаптировать игровую еду под реальные ингредиенты;</li>
                                    <li>подобрать меню для вечера настольных игр.</li>
                                </ul>
                            </div>

                            <div v-else>
                                <div v-if="isEditing">
                                    <input
                                        v-model="recipeTitle"
                                        type="text"
                                        placeholder="Название рецепта"
                                        style="margin-bottom: 10px;"
                                    />
                                    <textarea
                                        v-model="editedContent"
                                        class="recipe-content editable"
                                        style="min-height: 600px;"
                                    ></textarea>
                                    <div class="recipe-actions">
                                        <button class="primary-button" @click="saveEdit" :disabled="savingRecipe">
                                            [[ savingRecipe ? 'Сохранение...' : 'Сохранить изменения' ]]
                                        </button>
                                        <button class="secondary-button" @click="cancelEdit">Отмена</button>
                                    </div>
                                </div>
                                <div v-else>
                                    <div class="recipe-content">
                                        [[ currentRecipe ]]
                                    </div>
                                    <div class="recipe-actions" v-if="user && currentRecipe">
                                        <button class="primary-button" @click="saveRecipe" :disabled="savingRecipe">
                                            [[ savingRecipe ? 'Сохранение...' : 'Сохранить рецепт' ]]
                                        </button>
                                        <button v-if="currentRecipeId" class="secondary-button" @click="isEditing = true; editedContent = currentRecipe; recipeTitle = savedRecipes.find(r => r.id === currentRecipeId)?.title || ''">
                                            Редактировать
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="badge-row">
                                <div class="badge-row-left">
                                    <div class="badge-row-pill">
                                        [[ shortGameHint ]]
                                    </div>
                                    <span v-if="error" class="error-text">[[ error ]]</span>
                                </div>
                                <div class="badge-row-right">
                                    session • <span>[[ sessionLabel ]]</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Вкладка личного кабинета -->
                <div v-if="activeTab === 'cabinet'">
                    <div v-if="!user" class="empty-state">
                        <div class="empty-state-title">Войдите, чтобы увидеть свои сохранённые рецепты.</div>
                        <div class="hint">Используйте кнопки «Вход» или «Регистрация» вверху.</div>
                    </div>
                    <div v-else class="cabinet-layout">
                        <div class="cabinet-list">
                            <div class="panel-header">
                                <div>
                                    <div class="panel-title">Мои рецепты</div>
                                    <div class="panel-subtitle">Список ваших сохранённых рецептов</div>
                                </div>
                                <button class="secondary-button" @click="loadRecipes">
                                    Обновить
                                </button>
                            </div>
                            <div v-if="savedRecipes.length === 0" class="empty-state">
                                <div class="empty-state-title">У вас пока нет сохранённых рецептов.</div>
                                <div>Сгенерируйте рецепт на вкладке «Генерация» и сохраните его.</div>
                            </div>
                            <div v-else class="recipe-list">
                                <div
                                    v-for="recipe in savedRecipes"
                                    :key="recipe.id"
                                    class="recipe-item"
                                    @click="loadRecipeForEdit(recipe.id)"
                                >
                                    <div class="recipe-item-title">[[ recipe.title ]]</div>
                                    <div class="recipe-item-preview">
                                        [[ recipe.content.replace(/<br\s*\/?>/gi, '\n').split('\n')[0]?.substring(0, 100) ]]
                                    </div>
                                    <div class="recipe-item-meta">
                                        [[ new Date(recipe.created_at).toLocaleDateString('ru-RU') ]]
                                        <button
                                            class="secondary-button"
                                            style="margin-left: 8px; padding: 2px 8px; font-size: 10px;"
                                            @click.stop="deleteRecipe(recipe.id)"
                                        >
                                            Удалить
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="cabinet-details">
                            <div class="result-header">
                                <div class="result-title">Выбранный рецепт</div>
                            </div>
                            <div v-if="!currentRecipe" class="empty-state">
                                <div class="empty-state-title">Выберите рецепт слева, чтобы посмотреть или отредактировать его.</div>
                            </div>
                            <div v-else>
                                <div v-if="isEditing">
                                    <input
                                        v-model="recipeTitle"
                                        type="text"
                                        placeholder="Название рецепта"
                                        class="cabinet-title-input"
                                    />
                                    <textarea
                                        v-model="editedContent"
                                        class="recipe-content editable"
                                        style="min-height: 400px;"
                                    ></textarea>
                                    <div class="recipe-actions">
                                        <button class="primary-button" @click="saveEdit" :disabled="savingRecipe">
                                            [[ savingRecipe ? 'Сохранение...' : 'Сохранить изменения' ]]
                                        </button>
                                        <button class="secondary-button" @click="cancelEdit">Отмена</button>
                                    </div>
                                </div>
                                <div v-else>
                                    <div class="recipe-content">
                                        [[ currentRecipe ]]
                                    </div>
                                    <div class="recipe-actions">
                                        <button
                                            class="secondary-button"
                                            @click="isEditing = true; editedContent = currentRecipe; recipeTitle = savedRecipes.find(r => r.id === currentRecipeId)?.title || ''"
                                            :disabled="!currentRecipeId"
                                        >
                                            Редактировать
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно входа -->
        <div v-if="showLoginModal" class="modal-overlay" @click.self="showLoginModal = false">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-title">Вход</div>
                    <button class="modal-close" @click="showLoginModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div v-if="authError" class="error-text" style="margin-bottom: 10px;">[[ authError ]]</div>
                    <input
                        v-model="loginUsername"
                        type="text"
                        placeholder="Имя пользователя"
                        style="margin-bottom: 10px;"
                    />
                    <input
                        v-model="loginPassword"
                        type="password"
                        placeholder="Пароль"
                    />
                </div>
                <div class="modal-footer">
                    <button class="secondary-button" @click="showLoginModal = false">Отмена</button>
                    <button class="primary-button" @click="handleLogin" :disabled="authLoading">
                        [[ authLoading ? 'Вход...' : 'Войти' ]]
                    </button>
                </div>
            </div>
        </div>

        <!-- Модальное окно регистрации -->
        <div v-if="showRegisterModal" class="modal-overlay" @click.self="showRegisterModal = false">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-title">Регистрация</div>
                    <button class="modal-close" @click="showRegisterModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div v-if="authError" class="error-text" style="margin-bottom: 10px;">[[ authError ]]</div>
                    <input
                        v-model="registerUsername"
                        type="text"
                        placeholder="Имя пользователя"
                        style="margin-bottom: 10px;"
                    />
                    <input
                        v-model="registerPassword"
                        type="password"
                        placeholder="Пароль"
                    />
                </div>
                <div class="modal-footer">
                    <button class="secondary-button" @click="showRegisterModal = false">Отмена</button>
                    <button class="primary-button" @click="handleRegister" :disabled="authLoading">
                        [[ authLoading ? 'Регистрация...' : 'Зарегистрироваться' ]]
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>
